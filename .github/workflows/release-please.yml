# Release Please Workflow
# Automates releases with semantic versioning and changelog generation

name: Release Please

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest

    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}

    steps:
      - name: Run Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  # Optional: Add post-release actions here
  # For example, publishing to a package registry or deploying documentation
  post-release:
    name: Post Release Actions
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog generation

      - name: Log release info
        run: |
          echo "Release created: ${{ needs.release-please.outputs.tag_name }}"
          echo "Version: ${{ needs.release-please.outputs.version }}"

      - name: Get previous tag
        id: prev_tag
        run: |
          # Get the tag before the current release
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          echo "prev_tag=$PREV_TAG" >> "$GITHUB_OUTPUT"
          echo "Previous tag: $PREV_TAG"

      - name: Generate workflow changelog
        if: steps.prev_tag.outputs.prev_tag != ''
        run: |
          # Generate changelog entry for workflow changes
          ENTRY=$(./scripts/generate-workflow-changelog.sh \
            "${{ steps.prev_tag.outputs.prev_tag }}" \
            "${{ needs.release-please.outputs.tag_name }}")

          if [ -n "$ENTRY" ]; then
            echo "Workflow changes detected:"
            echo "$ENTRY"

            # Prepend to WORKFLOW_CHANGELOG.md
            {
              head -n 7 docs/WORKFLOW_CHANGELOG.md
              echo "$ENTRY"
              tail -n +8 docs/WORKFLOW_CHANGELOG.md
            } > docs/WORKFLOW_CHANGELOG.md.tmp
            mv docs/WORKFLOW_CHANGELOG.md.tmp docs/WORKFLOW_CHANGELOG.md
          else
            echo "No workflow changes in this release"
          fi

      - name: Commit changelog updates
        if: steps.prev_tag.outputs.prev_tag != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet docs/WORKFLOW_CHANGELOG.md; then
            echo "No changes to commit"
          else
            git add docs/WORKFLOW_CHANGELOG.md
            git commit -m "docs: update workflow changelog for ${{ needs.release-please.outputs.tag_name }}"
            git push
          fi

      # Add additional post-release steps here as needed
      # Examples:
      # - Deploy documentation to GitHub Pages
      # - Send notifications
      # - Trigger downstream workflows
